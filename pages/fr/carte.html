        function toggleReservation(id, name, button, lang) {
            try {
                const popup = button.parentElement;
                const isReserved = popup.getAttribute('data-reserved') === 'true';
                popup.setAttribute('data-reserved', !isReserved);
                button.textContent = isReserved ? 'R√©server' : 'Annuler';

                if (!isReserved) {
                    reservedSpots.push({ id, name });
                } else {
                    reservedSpots = reservedSpots.filter(spot => spot.id !== id);
                }
                
                updateEmailBody(lang);
                updateMarkers(lang);
            } catch (e) {
                console.error('Erreur toggle r√©servation:', e);
            }
        }

        function openGoogleMaps(url) {
            window.open(url, '_blank');
        }

        function updateEmailBody(lang) {
            try {
                const emailBody = document.getElementById(`email-body-${lang}`);
                const sendButton = document.getElementById(`send-email-${lang}`);
                const resetButton = document.getElementById(`reset-button`);

                if (!emailBody || !sendButton || !resetButton) return;

                if (reservedSpots.length > 0) {
                    const spotList = reservedSpots.map(spot => `Emplacement ${spot.id} - ${spot.name}`).join('\n\n');
                    emailBody.value = `Bonjour Patrick,

Je souhaite r√©server les emplacements publicitaires suivants :

${spotList}

Merci de confirmer la disponibilit√©.

Cordialement,
[Votre Nom]`;
                    sendButton.style.display = 'inline-block';
                    resetButton.style.display = 'inline-block';
                } else {
                    emailBody.value = `Instructions :

1. Cliquez sur un emplacement sur la carte.

2. Appuyez sur "R√©server" pour ajouter l'emplacement √† votre s√©lection.

3. Consultez l'emplacement sur Google Maps en cliquant sur "Voir sur Google Maps".

4. Une fois vos emplacements choisis, modifiez ce texte si n√©cessaire.

5. Cliquez sur "Envoyer l'e-mail" pour soumettre votre demande √† Patrick.`;
                    sendButton.style.display = 'none';
                    resetButton.style.display = 'none';
                }
            } catch (e) {
                console.error('Erreur mise √† jour e-mail:', e);
            }
        }

        function resetReservations(lang) {
            reservedSpots = [];
            updateEmailBody(lang);
            updateMarkers(lang);
        }

        function setupEventListeners(lang) {
            try {
                const sendButton = document.getElementById(`send-email-${lang}`);
                const resetButton = document.getElementById(`reset-button`);

                if (sendButton) {
                    sendButton.addEventListener('click', () => {
                        const emailBody = document.getElementById(`email-body-${lang}`);
                        const subject = encodeURIComponent("Demande de r√©servation d'emplacements publicitaires");
                        const body = encodeURIComponent(emailBody.value);
                        window.location.href = `mailto:patrick@xtranumerik.ca?subject=${subject}&body=${body}`;
                    });
                }

                if (resetButton) {
                    resetButton.addEventListener('click', () => {
                        resetReservations(lang);
                    });
                }
            } catch (e) {
                console.error('Erreur configuration √©couteurs:', e);
            }
        }

        function generateLocationList() {
            const locationList = document.getElementById('location-list');
            if (!locationList) return;

            adSpots.forEach(spot => {
                const locationItem = document.createElement('div');
                locationItem.className = 'location-item';
                locationItem.id = `location-${spot.id}`;
                locationItem.innerHTML = `
                    <div class="location-header">
                        <div style="flex: 1;">
                            <h4 class="location-title">Emplacement ${spot.id} - ${spot.name}</h4>
                            <div class="visitors-count">üë• ${spot.visitors}</div>
                        </div>
                        <div>üìç</div>
                    </div>
                    <p class="location-description">${spot.description}</p>
                    <div class="location-stats">
                        <span class="stat-badge traffic-badge">Achalandage √âlev√©</span>
                        <span class="stat-badge status-badge">Disponible</span>
                    </div>
                `;

                locationItem.addEventListener('click', () => {
                    if (mapFr) {
                        selectedLocationId = spot.id;
                        mapFr.setView([spot.lat, spot.lng], 15);
                        const marker = markers.find(m => m.location.id === spot.id);
                        if (marker) {
                            marker.marker.openPopup();
                        }
                        highlightLocationInList(spot.id);
                    }
                });

                locationList.appendChild(locationItem);
            });
        }

        function highlightLocationInList(locationId) {
            document.querySelectorAll('.location-item').forEach(item => {
                item.classList.remove('selected');
            });
            const locationElement = document.getElementById(`location-${locationId}`);
            if (locationElement) {
                locationElement.classList.add('selected');
                locationElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Fonctions de contr√¥le de la carte
        function centerMap() {
            if (mapFr) {
                mapFr.setView([46.0, -70.7], 8);
            }
        }

        function showAllLocations() {
            if (mapFr && markers.length > 0) {
                const group = L.featureGroup(markers.map(m => m.marker));
                mapFr.fitBounds(group.getBounds().pad(0.05));
            }
        }

        function filterAvailable() {
            showAllLocations();
        }
    </script>
</body>
</html>